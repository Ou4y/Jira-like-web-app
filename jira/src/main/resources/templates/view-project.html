<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />
    <style>
        .draggable-task {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .draggable-task:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .drop-zone {
            min-height: 150px;
            transition: background-color 0.2s;
        }
        .drop-zone.dragover {
            background-color: rgba(0, 123, 255, 0.1);
            outline: 2px dashed #007bff;
        }
        .empty-placeholder {
            height: 40px;
            border: 2px dashed #ccc;
            margin: 5px 0;
            background-color: #f8f9fa;
        }
        .sp-badge {
            min-width: 50px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light">
  <div th:replace="fragments/navbar :: navbar"></div>

  <div class="container mt-4">
      <!-- Project Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 th:text="${project.name}"></h1>
          <a th:href="@{/projects}" class="btn btn-outline-primary">Back to Projects</a>
      </div>

      <!-- Project Details Card -->
      <div class="card mb-4 shadow">
          <div class="card-body">
              <!-- Project details content remains the same -->
          </div>
      </div>

      <!-- Scrum Board -->
      <div class="card mb-4 shadow">
          <div class="card-header bg-primary text-white">
              <h4 class="mb-0">Scrum Board</h4>
          </div>
          <div class="card-body">
              <div class="row g-3">
                  <div th:each="colStatus : ${T(com.jira.jira.models.Task.Status).values()}" 
                       class="col-md-4">
                      <div class="card h-100">
                          <div class="card-header bg-secondary text-white">
                              <h5 class="card-title mb-0" th:text="${colStatus.displayName}"></h5>
                          </div>
                          <div class="card-body p-2">
                              <ul class="list-group drop-zone" 
                                  th:data-status="${colStatus.name()}"
                                  ondragover="handleDragOver(event)" 
                                  ondragleave="handleDragLeave(event)"
                                  ondrop="handleDrop(event)">
                                  
                                  <!-- Corrected Task Item -->
                                  <li class="list-group-item draggable-task d-flex justify-content-between align-items-center"
                                      th:each="task : ${project.tasks}"
                                      th:if="${task.status.name() == colStatus.name()}"
                                      draggable="true"
                                      th:data-task-id="${task.id}">
                                      <span th:text="${task.title}"></span>
                                      <span class="badge sp-badge" 
                                            th:classappend="${(task.storyPoints == 1) ? 'bg-success' : 
                                                            ((task.storyPoints == 2) or (task.storyPoints == 3)) ? 'bg-primary' : 
                                                            ((task.storyPoints == 5) or (task.storyPoints == 8)) ? 'bg-warning' : 
                                                            (task.storyPoints >= 13) ? 'bg-danger' : ''}"
                                            th:text="${task.storyPoints}"></span>
                                  </li>

                                  <div class="empty-placeholder text-center p-2 text-muted"
                                       th:if="${#lists.isEmpty(project.tasks.?[status.name() == colStatus.name()])}">
                                      No tasks in this column
                                  </div>
                              </ul>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Task Management Section -->
      <div class="row">
          <!-- Task List -->
          <div class="col-md-8">
              <div class="card shadow mb-4">
                  <div class="card-header bg-dark text-white">
                      <h5 class="mb-0">Task Backlog</h5>
                  </div>
                  <div class="card-body">
                      <div class="table-responsive">
                          <table class="table table-hover">
                              <thead>
                                  <tr>
                                      <th>Title</th>
                                      <th>Status</th>
                                      <th>Story Points</th>
                                      <th>Actions</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  <tr th:each="task : ${project.tasks}">
                                      <td th:text="${task.title}"></td>
                                      <td>
                                          <span class="badge" 
                                                th:classappend="${task.status.name() == 'TODO'} ? 'bg-secondary' : 
                                                                ${task.status.name() == 'IN_PROGRESS'} ? 'bg-primary' : 
                                                                'bg-success'"
                                                th:text="${task.status.displayName}"></span>
                                      </td>
                                      <td>
                                          <!-- Corrected Story Points Badge -->
                                          <span class="badge sp-badge" 
                                                th:classappend="${(task.storyPoints == 1) ? 'bg-success' : 
                                                                ((task.storyPoints == 2) or (task.storyPoints == 3)) ? 'bg-primary' : 
                                                                ((task.storyPoints == 5) or (task.storyPoints == 8)) ? 'bg-warning' : 
                                                                (task.storyPoints >= 13) ? 'bg-danger' : ''}"
                                                th:text="${task.storyPoints}"></span>
                                      </td>
                                      <td>
                                          <a th:href="@{/tasks/edit/{id}(id=${task.id})" 
                                             class="btn btn-sm btn-outline-warning me-2">Edit</a>
                                          <a th:href="@{/tasks/delete/{id}(id=${task.id})" 
                                             class="btn btn-sm btn-outline-danger">Delete</a>
                                      </td>
                                  </tr>
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>

        <!-- Task Management Section -->
        <div class="row">
            <!-- Task List -->
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Task Backlog</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Story Points</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="task : ${project.tasks}">
                                        <td th:text="${task.title}"></td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${task.status.name() == 'TODO'} ? 'bg-secondary' :
                                                                  ${task.status.name() == 'IN_PROGRESS'} ? 'bg-primary' :
                                                                  'bg-success'"
                                                  th:text="${task.status.displayName}"></span>
                                        </td>
                                        <td>
                                            <span class="badge sp-badge" 
                                                  th:classappend="${task.storyPoints == 1} ? 'bg-success' :
                                                                  ${task.storyPoints == 2 or task.storyPoints == 3} ? 'bg-primary' :
                                                                  ${task.storyPoints == 5 or task.storyPoints == 8} ? 'bg-warning' :
                                                                  'bg-danger'"
                                                  th:text="${task.storyPoints}"></span>
                                        </td>
                                        <td>
                                            <a th:href="@{/tasks/edit/{id}(id=${task.id})" 
                                               class="btn btn-sm btn-outline-warning me-2">Edit</a>
                                            <a th:href="@{/tasks/delete/{id}(id=${task.id})" 
                                               class="btn btn-sm btn-outline-danger">Delete</a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Task Form -->
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Create New Task</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/tasks/add}" method="post">
                            <input type="hidden" name="projectId" th:value="${project.id}">
                            
                            <div class="mb-3">
                                <label class="form-label">Task Title</label>
                                <input type="text" name="title" class="form-control" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="3" required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select name="status" class="form-select" required>
                                    <option th:each="status : ${T(com.jira.jira.models.Task.Status).values()}"
                                            th:value="${status.name()}"
                                            th:text="${status.displayName}"></option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Story Points</label>
                                <select name="storyPoints" class="form-select" required>
                                    <option value="1">1 - Small</option>
                                    <option value="2">2</option>
                                    <option value="3">3 - Medium</option>
                                    <option value="5">5</option>
                                    <option value="8">8 - Large</option>
                                    <option value="13">13 - Epic</option>
                                </select>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">Add Task</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Drag & Drop Functionality
        let draggedElement = null;
        let originalColumn = null;

        const handleDragStart = (e) => {
            draggedElement = e.target.closest('.draggable-task');
            originalColumn = draggedElement.parentElement;
            e.dataTransfer.setData('text/plain', draggedElement.dataset.taskId);
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            const dz = e.target.closest('.drop-zone');
            dz?.classList.add('dragover');
        };

        const handleDragLeave = (e) => {
            const dz = e.target.closest('.drop-zone');
            dz?.classList.remove('dragover');
        };

        const handleDrop = async (e) => {
            e.preventDefault();
            const dz = e.target.closest('.drop-zone');
            if (!dz || !draggedElement) return;
            
            dz.classList.remove('dragover');
            const newStatus = dz.dataset.status;
            const taskId = draggedElement.dataset.taskId;
            
            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
                
                const response = await fetch(`/tasks/update-status/${taskId}?newStatus=${newStatus}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                });

                if (response.ok) {
                    // Move task visually
                    const newTask = draggedElement.cloneNode(true);
                    newTask.addEventListener('dragstart', handleDragStart);
                    dz.querySelector('.list-group').insertBefore(newTask, dz.querySelector('.empty-placeholder'));
                    draggedElement.remove();
                    
                    // Update placeholders
                    updatePlaceholders(originalColumn);
                    updatePlaceholders(dz);
                } else {
                    throw new Error('Status update failed');
                }
            } catch (error) {
                console.error('Error:', error);
                originalColumn.appendChild(draggedElement);
            } finally {
                draggedElement = null;
                originalColumn = null;
            }
        };

        const updatePlaceholders = (container) => {
            const hasTasks = container.querySelector('.draggable-task') !== null;
            const placeholder = container.querySelector('.empty-placeholder');
            
            if (hasTasks && placeholder) {
                placeholder.remove();
            } else if (!hasTasks && !placeholder) {
                const ph = document.createElement('div');
                ph.className = 'empty-placeholder text-center p-2 text-muted';
                ph.textContent = 'No tasks in this column';
                container.appendChild(ph);
            }
        };

        // Initialize event listeners
        document.querySelectorAll('.draggable-task').forEach(task => {
            task.addEventListener('dragstart', handleDragStart);
        });

        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });
    </script>
</body>
</html>